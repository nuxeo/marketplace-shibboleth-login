<project name="shibboleth-authentication-webdriver-tests" xmlns:nx="urn:nuxeo-build"
  xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build"/>
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml" uri="urn:nuxeo-artifact"/>
  <taskdef resource="net/sf/antcontrib/antlib.xml"/>

  <property name="out.dir" value="${maven.project.build.directory}"/>
  <condition property="idp.credentials.dir" value="${env.IDP_CREDENTIALS_DIR}" else="/opt/shibboleth-idp/credentials">
    <isset property="env.IDP_CREDENTIALS_DIR" />
  </condition>
  <condition property="sp.credentials.dir" value="${env.SP_CREDENTIALS_DIR}" else="/etc/ssl/certs">
    <isset property="env.SP_CREDENTIALS_DIR" />
  </condition>

  <unzip dest="${out.dir}/" overwrite="false">
    <artifact:resolveFile key="org.nuxeo:nuxeo-ftest::zip"/>
  </unzip>
  <import file="${out.dir}/nuxeo-ftest.xml"/>

  <target name="prepare-ssl-environment">
    <exec executable="keytool" failonerror="false">
      <arg line="-import" />
      <arg line="-file ${idp.credentials.dir}/idp.crt" />
      <arg line="-alias idpcert" />
      <arg line="-keystore ${out.dir}/shibtruststore" />
      <arg line="-storepass password" />
      <arg line="-noprompt" />
    </exec>
    <exec executable="keytool" failonerror="false">
      <arg line="-import" />
      <arg line="-file ${sp.credentials.dir}/sp.shibboleth.com.crt" />
      <arg line="-alias spcert" />
      <arg line="-keystore ${out.dir}/shibtruststore" />
      <arg line="-storepass password" />
      <arg line="-noprompt" />
    </exec>
  </target>

</project>
